# Spring Boot 3 & OpenTelemetry

This repository is a small demonstration of how to use OpenTelemetry's _manual_ instrumentation to send logs, metrics and traces from Spring Boot, to a running OpenTelemtry Collector instance.
The goal is to make the integration as native as possible, i.e. build on top of the elements already provided by Spring Boot (Spring Actuator, Logback, Dependency Management, Autoconfiguration, etc.).

## Dataflow

- Traces generated by Micrometer (Spring Boot Actuator) are sent to using `io.micrometer:micrometer-tracing-bridge-otel`
- Metrics generated by Micrometer are sent via the OpenTelemetry Protocol (OTLP) using `io.micrometer:micrometer-registry-otlp` and `io.opentelemetry:opentelemetry-exporter-otlp`
- Logs generated by using Logback (SLF4J) are sent via OTLP using `io.opentelemetry.instrumentation:opentelemetry-logback-appender-1.0`

## Visualisation

The repository comes with a Docker Compose file that helps visualize the collected data.
It provides pre-configured instances of OpenTelemetry Collector, Prometheus, Grafana, Grafana Loki and Grafana Tempo.
So if Docker is already installed on your machine, it just needs a

```shell
docker compose up -d
```

and the stack is ready to use.
To visit Grafana, go to `http://localhost:3000`.

If you're not yet familiar with Grafana, here is a very brief introduction:

In the “Explore” tab you can view the data contained in the different data sources and try out your own queries.
For metrics select “Prometheus”, for logs “Loki” and for traces “Tempo”.

## Sample Data

Currently, there is not much to see in Grafana, but we can easily change that.
First we need to build and launch the Spring application:

```shell
./mvnw spring-boot:run
```

The logs and metrics should be visible now; to get some traces as well, we'll need run some HTTP requests (in another shell):

```shell
curl 'localhost:8080'
curl 'localhost:8080?name=John'
curl 'localhost:8080?name=Luke'
```

You should now be able to see all metrics, logs and traces in Grafana.

For example, to see all logs, select the data source “Loki”, set the label filter to “job=otel-demo” and click “Run query”.
You might now want to add a JSON parser (a hint to add it should already be displayed) and discover the query language graphically.

To see the traces, select the data source “Tempo” and click “Run query”.
The three HTTP requests executed above should result in three displayed traces.
Click on the ID of one to see its details.
A “Log” button should now be visible, that will show you all the logs that belong to that trace.

You can explore the metrics using the data source “Prometheus”.
Select any metric (e.g. `jvm_memory_used_bytes`) and click “Run query”.
